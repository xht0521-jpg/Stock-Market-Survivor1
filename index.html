<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ì‹œì¥ ìƒì¡´ ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .game-screen {
            display: none;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
            min-width: 150px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .profit {
            color: #00ff88;
        }

        .loss {
            color: #ff4757;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-section, .trading-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stock-list {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stock-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .stock-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00d4ff;
        }

        .stock-item.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .stock-info {
            flex: 1;
        }

        .stock-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stock-price {
            font-size: 1.2em;
            margin: 5px 0;
        }

        .stock-change {
            font-size: 0.9em;
        }

        .indicators {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        .trading-controls {
            display: grid;
            gap: 10px;
        }

        .trade-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .trade-input-group input {
            flex: 1;
        }

        .trade-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .buy-btn {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
        }

        .sell-btn {
            background: linear-gradient(45deg, #ff4757, #ff6348);
        }

        .portfolio {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .portfolio-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .event-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .event-positive {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
        }

        .event-negative {
            background: rgba(255, 71, 87, 0.1);
            border-left: 3px solid #ff4757;
        }

        .event-neutral {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #999;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .ranking-medal {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            border-radius: 5px;
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            color: #000;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
            }

            .stat-card {
                width: 100%;
            }
        }

        .hidden {
            display: none;
        }

        .leverage-selector, .ai-config {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        canvas {
            max-height: 400px;
        }

        .room-code-display {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
            padding: 20px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }

        .opponent-list {
            margin-top: 20px;
        }

        .opponent-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>ğŸ“ˆ ì£¼ì‹ ì‹œì¥ ìƒì¡´ ê²Œì„</h1>
            <p style="margin-bottom: 30px; color: #999;">30ì¼ ë™ì•ˆ ìì‚°ì„ ëŠ˜ë ¤ë³´ì„¸ìš”!</p>
            
            <input type="text" id="playerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showModeTab('single')">ì‹±ê¸€ í”Œë ˆì´</button>
                <button class="tab-btn" onclick="showModeTab('multi')">ì¹œêµ¬ ëŒ€ê²°</button>
                <button class="tab-btn" onclick="showModeTab('ai')">AI ëŒ€ì „</button>
            </div>

            <div id="singleMode" class="mode-section">
                <button onclick="startGame('single')">ê²Œì„ ì‹œì‘</button>
            </div>

            <div id="multiMode" class="mode-section hidden">
                <button onclick="createRoom()">ë°© ë§Œë“¤ê¸°</button>
                <input type="text" id="roomCodeInput" placeholder="ë°© ì½”ë“œ ì…ë ¥ (4ìë¦¬)" maxlength="4">
                <button onclick="joinRoom()">ë°© ì°¸ì—¬í•˜ê¸°</button>
            </div>

            <div id="aiMode" class="mode-section hidden">
                <select id="aiDifficulty">
                    <option value="beginner">ì´ˆë³´ AI</option>
                    <option value="intermediate">ì¤‘ê¸‰ AI</option>
                    <option value="expert">ì „ë¬¸ê°€ AI</option>
                </select>
                <select id="aiStyle">
                    <option value="buffett">ì›Œë Œ ë²„í• ìŠ¤íƒ€ì¼</option>
                    <option value="lynch">í”¼í„° ë¦°ì¹˜ ìŠ¤íƒ€ì¼</option>
                    <option value="trader">ê¸‰ì§„ì  íŠ¸ë ˆì´ë”</option>
                </select>
                <button onclick="startGame('ai')">AI ëŒ€ì „ ì‹œì‘</button>
            </div>

            <button onclick="showRankings()" style="margin-top: 20px; background: rgba(255,255,255,0.1);">ğŸ† ë­í‚¹ ë³´ê¸°</button>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameScreen" class="game-screen">
        <div class="container">
            <div class="header">
                <div class="stat-card">
                    <div class="stat-label">í”Œë ˆì´ì–´</div>
                    <div class="stat-value" id="playerNameDisplay">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Day</div>
                    <div class="stat-value" id="currentDay">1</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì´ ìì‚°</div>
                    <div class="stat-value" id="totalAssets">10,000,000ì›</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ìˆ˜ìµë¥ </div>
                    <div class="stat-value" id="returnRate">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ê±°ë˜ íšŸìˆ˜</div>
                    <div class="stat-value" id="tradeCount">0/20</div>
                </div>
            </div>

            <div class="main-content">
                <div class="chart-section">
                    <h2>ì£¼ê°€ ì°¨íŠ¸</h2>
                    <canvas id="priceChart"></canvas>
                    <div id="stockList" class="stock-list"></div>
                </div>

                <div class="trading-section">
                    <h2>ê±°ë˜</h2>
                    <div id="selectedStockInfo">ì£¼ì‹ì„ ì„ íƒí•˜ì„¸ìš”</div>
                    
                    <div class="trading-controls">
                        <div class="leverage-selector">
                            <label>ë ˆë²„ë¦¬ì§€:</label>
                            <div class="radio-group">
                                <label><input type="radio" name="leverage" value="1" checked> 1ë°°</label>
                                <label><input type="radio" name="leverage" value="1.5"> 1.5ë°°</label>
                                <label><input type="radio" name="leverage" value="2"> 2ë°°</label>
                            </div>
                        </div>

                        <div class="trade-input-group">
                            <input type="number" id="tradeAmount" placeholder="ìˆ˜ëŸ‰" min="1">
                            <button onclick="setMaxAmount()">ìµœëŒ€</button>
                        </div>

                        <div class="trade-buttons">
                            <button class="buy-btn" onclick="executeTrade('buy')">ë§¤ìˆ˜</button>
                            <button class="sell-btn" onclick="executeTrade('sell')">ë§¤ë„</button>
                        </div>

                        <button onclick="executeTrade('short')" style="background: linear-gradient(45deg, #9c27b0, #673ab7); margin-top: 10px;">ê³µë§¤ë„</button>
                    </div>
                </div>
            </div>

            <div class="portfolio">
                <h2>í¬íŠ¸í´ë¦¬ì˜¤</h2>
                <div>í˜„ê¸ˆ: <span id="cash">10,000,000ì›</span></div>
                <div id="portfolioList"></div>
            </div>

            <div class="event-log">
                <h2>ì‹œì¥ ì´ë²¤íŠ¸</h2>
                <div id="eventList"></div>
            </div>

            <div id="opponentSection" class="hidden">
                <div class="portfolio">
                    <h2>ìƒëŒ€ë°© í˜„í™©</h2>
                    <div id="opponentList" class="opponent-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="rankingModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ† ë­í‚¹</h2>
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showRankingTab('overall')">ì¢…í•©</button>
                <button class="tab-btn" onclick="showRankingTab('weekly')">ì£¼ê°„</button>
                <button class="tab-btn" onclick="showRankingTab('friends')">ì¹œêµ¬</button>
            </div>
            <div id="rankingContent"></div>
            <button onclick="closeModal('rankingModal')">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2>ê²Œì„ ì¢…ë£Œ!</h2>
            <div id="resultContent"></div>
            <canvas id="resultChart"></canvas>
            <button onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘</button>
        </div>
    </div>

    <div id="roomWaitModal" class="modal">
        <div class="modal-content">
            <h2>ëŒ€ê¸°ì‹¤</h2>
            <div class="room-code-display" id="roomCodeDisplay"></div>
            <p>ì¹œêµ¬ì—ê²Œ ì´ ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”!</p>
            <div id="roomPlayerList"></div>
            <button onclick="startMultiplayerGame()">ê²Œì„ ì‹œì‘</button>
            <button onclick="closeModal('roomWaitModal')">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
  apiKey: "AIzaSyD4dXEjB7jIBGg1tdF6FxoV-AKw7UhyJac",
  authDomain: "stock-market-survivor1.firebaseapp.com",
  databaseURL: "https://stock-market-survivor1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "stock-market-survivor1",
  storageBucket: "stock-market-survivor1.firebasestorage.app",
  messagingSenderId: "1087443921138",
  appId: "1:1087443921138:web:489d66bf14415ba3b3486b",
  measurementId: "G-C23W8MB1WD"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch (error) {
            console.log("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ - ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.");
        }

        // ê²Œì„ ìƒíƒœ
        const gameState = {
            mode: 'single',
            playerName: '',
            playerId: '',
            currentDay: 1,
            cash: 10000000,
            portfolio: {},
            stocks: [],
            selectedStock: null,
            tradeCount: 0,
            maxTrades: 20,
            assetHistory: [10000000],
            tradeHistory: [],
            eventHistory: [],
            roomCode: null,
            opponents: {},
            aiPlayer: null,
            isPaused: false
        };

        // ì£¼ì‹ ë°ì´í„° ì´ˆê¸°í™”
        const stockTemplates = [
            { name: 'í…Œí¬ì½”ë¦¬ì•„', symbol: 'TECH', basePrice: 50000, volatility: 0.08, sector: 'technology' },
            { name: 'ì—ë„ˆì§€í”ŒëŸ¬ìŠ¤', symbol: 'ENRG', basePrice: 30000, volatility: 0.12, sector: 'energy' },
            { name: 'ê¸ˆìœµê·¸ë£¹', symbol: 'FIN', basePrice: 40000, volatility: 0.05, sector: 'finance' },
            { name: 'ì œì¡°ì‚°ì—…', symbol: 'MNFG', basePrice: 35000, volatility: 0.06, sector: 'manufacturing' },
            { name: 'ë°”ì´ì˜¤í—¬ìŠ¤', symbol: 'BIO', basePrice: 60000, volatility: 0.15, sector: 'bio' }
        ];

        function initStocks() {
            gameState.stocks = stockTemplates.map(template => ({
                ...template,
                price: template.basePrice,
                priceHistory: [template.basePrice],
                change: 0,
                changePercent: 0,
                ma5: template.basePrice,
                ma20: template.basePrice,
                rsi: 50
            }));
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        let priceChart;
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [1],
                    datasets: gameState.stocks.map((stock, idx) => ({
                        label: stock.name,
                        data: [stock.price],
                        borderColor: `hsl(${idx * 72}, 70%, 50%)`,
                        tension: 0.4,
                        hidden: idx > 0
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: '#e0e0e0' },
                            onClick: (e, legendItem, legend) => {
                                const index = legendItem.datasetIndex;
                                const chart = legend.chart;
                                const meta = chart.getDatasetMeta(index);
                                meta.hidden = !meta.hidden;
                                chart.update();
                            }
                        }
                    },
                    scales: {
                        y: { 
                            ticks: { color: '#e0e0e0' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: '#e0e0e0' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // ëª¨ë“œ íƒ­ ì „í™˜
        function showModeTab(mode) {
            document.querySelectorAll('.mode-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(mode + 'Mode').classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ê²Œì„ ì‹œì‘
        function startGame(mode) {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            gameState.mode = mode;
            gameState.playerName = name;
            gameState.playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            if (mode === 'ai') {
                const difficulty = document.getElementById('aiDifficulty').value;
                const style = document.getElementById('aiStyle').value;
                initAI(difficulty, style);
            }

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('playerNameDisplay').textContent = name;

            if (mode === 'multi') {
                document.getElementById('opponentSection').classList.remove('hidden');
            }

            initStocks();
            initChart();
            renderStockList();
            updateDisplay();
            startGameLoop();
        }

        // ë°© ìƒì„±
        function createRoom() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!db) {
                alert('Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            const roomCode = String(Math.floor(1000 + Math.random() * 9000));
            gameState.roomCode = roomCode;
            gameState.playerName = name;
            gameState.playerId = 'player_' + Date.now();

            db.ref('rooms/' + roomCode).set({
                host: gameState.playerId,
                status: 'waiting',
                createdAt: Date.now(),
                players: {
                    [gameState.playerId]: {
                        name: name,
                        assets: 10000000,
                        ready: true
                    }
                }
            }).then(() => {
                document.getElementById('roomCodeDisplay').textContent = roomCode;
                document.getElementById('roomWaitModal').style.display = 'flex';
                listenToRoom(roomCode);
            });
        }

        // ë°© ì°¸ì—¬
        function joinRoom() {
            const name = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim();
            
            if (!name || !roomCode) {
                alert('ì´ë¦„ê³¼ ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (!db) {
                alert('Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            db.ref('rooms/' + roomCode).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤!');
                    return;
                }

                const room = snapshot.val();
                if (room.status !== 'waiting') {
                    alert('ì´ë¯¸ ì‹œì‘ëœ ë°©ì…ë‹ˆë‹¤!');
                    return;
                }

                const playerCount = Object.keys(room.players || {}).length;
                if (playerCount >= 4) {
                    alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');
                    return;
                }

                gameState.roomCode = roomCode;
                gameState.playerName = name;
                gameState.playerId = 'player_' + Date.now();

                db.ref('rooms/' + roomCode + '/players/' + gameState.playerId).set({
                    name: name,
                    assets: 10000000,
                    ready: false
                }).then(() => {
                    document.getElementById('roomCodeDisplay').textContent = roomCode;
                    document.getElementById('roomWaitModal').style.display = 'flex';
                    listenToRoom(roomCode);
                });
            });
        }

        // ë°© ìƒíƒœ ë¦¬ìŠ¤ë‹
        function listenToRoom(roomCode) {
            db.ref('rooms/' + roomCode).on('value', snapshot => {
                const room = snapshot.val();
                if (!room) return;

                const playerListHtml = Object.entries(room.players).map(([id, player]) => 
                    `<div class="opponent-item">
                        <span>${player.name}</span>
                        <span>${player.ready ? 'âœ“' : 'ëŒ€ê¸°ì¤‘'}</span>
                    </div>`
                ).join('');
                document.getElementById('roomPlayerList').innerHTML = playerListHtml;

                if (room.status === 'playing') {
                    closeModal('roomWaitModal');
                    startGame('multi');
                }

                // ì‹¤ì‹œê°„ ìƒëŒ€ë°© ìì‚° ì—…ë°ì´íŠ¸
                if (gameState.mode === 'multi') {
                    updateOpponentList(room.players);
                }
            });
        }

        // ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„ ì‹œì‘
        function startMultiplayerGame() {
            if (!db) return;
            db.ref('rooms/' + gameState.roomCode + '/status').set('playing');
        }

        // ìƒëŒ€ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateOpponentList(players) {
            const opponentHtml = Object.entries(players)
                .filter(([id]) => id !== gameState.playerId)
                .map(([id, player]) => {
                    const returnRate = ((player.assets - 10000000) / 10000000 * 100).toFixed(2);
                    const colorClass = returnRate >= 0 ? 'profit' : 'loss';
                    return `<div class="opponent-item">
                        <div>
                            <div>${player.name}</div>
                            <div style="font-size: 0.9em; color: #999;">ìì‚°: ${formatNumber(player.assets)}ì›</div>
                        </div>
                        <div class="${colorClass}">${returnRate}%</div>
                    </div>`;
                }).join('');
            document.getElementById('opponentList').innerHTML = opponentHtml || '<p>ë‹¤ë¥¸ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // AI ì´ˆê¸°í™”
        function initAI(difficulty, style) {
            gameState.aiPlayer = {
                name: 'AI ' + style.toUpperCase(),
                difficulty: difficulty,
                style: style,
                cash: 10000000,
                portfolio: {},
                assets: 10000000
            };
        }

        // AI ê±°ë˜ ë¡œì§
        function aiTrade() {
            if (!gameState.aiPlayer) return;

            const ai = gameState.aiPlayer;
            let tradeProbability = 0.1;
            
            if (ai.difficulty === 'intermediate') tradeProbability = 0.3;
            if (ai.difficulty === 'expert') tradeProbability = 0.5;

            if (Math.random() > tradeProbability) return;

            const stock = selectAIStock(ai);
            if (!stock) return;

            const action = Math.random() > 0.5 ? 'buy' : 'sell';
            const maxAmount = Math.floor(ai.cash / stock.price);
            
            if (action === 'buy' && maxAmount > 0) {
                const amount = Math.ceil(maxAmount * (0.1 + Math.random() * 0.3));
                const cost = amount * stock.price;
                if (cost <= ai.cash) {
                    ai.cash -= cost;
                    ai.portfolio[stock.symbol] = (ai.portfolio[stock.symbol] || 0) + amount;
                }
            } else if (action === 'sell' && ai.portfolio[stock.symbol]) {
                const amount = Math.ceil(ai.portfolio[stock.symbol] * (0.3 + Math.random() * 0.5));
                ai.cash += amount * stock.price;
                ai.portfolio[stock.symbol] -= amount;
                if (ai.portfolio[stock.symbol] <= 0) delete ai.portfolio[stock.symbol];
            }

            ai.assets = calculateAIAssets();
        }

        function selectAIStock(ai) {
            if (ai.difficulty === 'beginner') {
                return gameState.stocks[Math.floor(Math.random() * gameState.stocks.length)];
            }

            let candidates = gameState.stocks.filter(stock => {
                if (ai.style === 'buffett') {
                    const pe = stock.price / 1000;
                    return pe < 50 && stock.ma20 < stock.price;
                } else if (ai.style === 'lynch') {
                    return stock.changePercent > 2;
                } else {
                    return stock.volatility > 0.1;
                }
            });

            if (candidates.length === 0) candidates = gameState.stocks;

            if (ai.difficulty === 'expert') {
                candidates = candidates.filter(s => {
                    if (s.rsi < 30) return true;
                    if (s.rsi > 70) return false;
                    return s.ma5 > s.ma20;
                });
            }

            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function calculateAIAssets() {
            let total = gameState.aiPlayer.cash;
            for (let symbol in gameState.aiPlayer.portfolio) {
                const stock = gameState.stocks.find(s => s.symbol === symbol);
                total += gameState.aiPlayer.portfolio[symbol] * stock.price;
            }
            return total;
        }

        // ì£¼ì‹ ëª©ë¡ ë Œë”ë§
        function renderStockList() {
            const html = gameState.stocks.map(stock => {
                const changeClass = stock.change >= 0 ? 'profit' : 'loss';
                const changeSign = stock.change >= 0 ? '+' : '';
                return `
                    <div class="stock-item ${gameState.selectedStock?.symbol === stock.symbol ? 'selected' : ''}" 
                         onclick="selectStock('${stock.symbol}')">
                        <div class="stock-info">
                            <div class="stock-name">${stock.name} (${stock.symbol})</div>
                            <div class="stock-price">${formatNumber(stock.price)}ì›</div>
                            <div class="stock-change ${changeClass}">
                                ${changeSign}${formatNumber(stock.change)}ì› (${changeSign}${stock.changePercent.toFixed(2)}%)
                            </div>
                            <div class="indicators">
                                MA5: ${formatNumber(Math.round(stock.ma5))} | 
                                MA20: ${formatNumber(Math.round(stock.ma20))} | 
                                RSI: ${stock.rsi.toFixed(1)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('stockList').innerHTML = html;
        }

        // ì£¼ì‹ ì„ íƒ
        function selectStock(symbol) {
            gameState.selectedStock = gameState.stocks.find(s => s.symbol === symbol);
            renderStockList();
            updateSelectedStockInfo();
        }

        function updateSelectedStockInfo() {
            if (!gameState.selectedStock) return;
            const stock = gameState.selectedStock;
            const owned = gameState.portfolio[stock.symbol] || 0;
            document.getElementById('selectedStockInfo').innerHTML = `
                <h3>${stock.name}</h3>
                <p>í˜„ì¬ê°€: ${formatNumber(stock.price)}ì›</p>
                <p>ë³´ìœ : ${owned}ì£¼</p>
            `;
        }

        // ê±°ë˜ ì‹¤í–‰
        function executeTrade(type) {
            if (gameState.tradeCount >= gameState.maxTrades) {
                alert('ì˜¤ëŠ˜ì˜ ê±°ë˜ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!');
                return;
            }

            if (!gameState.selectedStock) {
                alert('ì£¼ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            const amount = parseInt(document.getElementById('tradeAmount').value);
            if (!amount || amount <= 0) {
                alert('ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const stock = gameState.selectedStock;
            const leverage = parseFloat(document.querySelector('input[name="leverage"]:checked').value);
            const effectiveAmount = Math.floor(amount * leverage);

            if (type === 'buy') {
                const cost = effectiveAmount * stock.price;
                if (cost > gameState.cash) {
                    alert('ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return;
                }
                gameState.cash -= cost;
                gameState.portfolio[stock.symbol] = (gameState.portfolio[stock.symbol] || 0) + effectiveAmount;
                addEvent(`${stock.name} ${effectiveAmount}ì£¼ ë§¤ìˆ˜ (${leverage}ë°° ë ˆë²„ë¦¬ì§€)`, 'positive');
            } else if (type === 'sell') {
                const owned = gameState.portfolio[stock.symbol] || 0;
                if (amount > owned) {
                    alert('ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return;
                }
                gameState.cash += amount * stock.price;
                gameState.portfolio[stock.symbol] -= amount;
                if (gameState.portfolio[stock.symbol] <= 0) {
                    delete gameState.portfolio[stock.symbol];
                }
                addEvent(`${stock.name} ${amount}ì£¼ ë§¤ë„`, 'positive');
            } else if (type === 'short') {
                gameState.portfolio[stock.symbol] = (gameState.portfolio[stock.symbol] || 0) - effectiveAmount;
                gameState.cash += effectiveAmount * stock.price;
                addEvent(`${stock.name} ${effectiveAmount}ì£¼ ê³µë§¤ë„ (${leverage}ë°° ë ˆë²„ë¦¬ì§€)`, 'negative');
            }

            gameState.tradeCount++;
            gameState.tradeHistory.push({
                day: gameState.currentDay,
                type: type,
                stock: stock.symbol,
                amount: effectiveAmount,
                price: stock.price,
                leverage: leverage
            });

            document.getElementById('tradeAmount').value = '';
            updateDisplay();
        }

        function setMaxAmount() {
            if (!gameState.selectedStock) return;
            const maxBuy = Math.floor(gameState.cash / gameState.selectedStock.price);
            document.getElementById('tradeAmount').value = maxBuy;
        }

        // ì‹œì¥ ì—…ë°ì´íŠ¸
        function updateMarket() {
            // ëœë¤ ì´ë²¤íŠ¸ ìƒì„±
            if (Math.random() < 0.3) {
                generateMarketEvent();
            }

            // ì£¼ê°€ ì—…ë°ì´íŠ¸
            gameState.stocks.forEach(stock => {
                const randomChange = (Math.random() - 0.5) * stock.volatility;
                const trend = (stock.ma5 > stock.ma20) ? 0.02 : -0.02;
                const change = randomChange + trend;
                
                const oldPrice = stock.price;
                stock.price = Math.max(1000, Math.round(stock.price * (1 + change)));
                stock.change = stock.price - oldPrice;
                stock.changePercent = (stock.change / oldPrice) * 100;
                
                stock.priceHistory.push(stock.price);
                if (stock.priceHistory.length > 30) stock.priceHistory.shift();

                // ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
                stock.ma5 = calculateMA(stock.priceHistory, 5);
                stock.ma20 = calculateMA(stock.priceHistory, 20);
                stock.rsi = calculateRSI(stock.priceHistory, 14);
            });

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            priceChart.data.labels.push(gameState.currentDay);
            gameState.stocks.forEach((stock, idx) => {
                priceChart.data.datasets[idx].data.push(stock.price);
            });
            if (priceChart.data.labels.length > 30) {
                priceChart.data.labels.shift();
                priceChart.data.datasets.forEach(ds => ds.data.shift());
            }
            priceChart.update('none');

            renderStockList();
        }

        function generateMarketEvent() {
            const events = [
                { text: 'ì •ë¶€ ê²½ê¸°ë¶€ì–‘ì±… ë°œí‘œ! ì‹œì¥ ì „ì²´ ìƒìŠ¹', type: 'positive', impact: 0.05 },
                { text: 'ê¸ˆë¦¬ ì¸ìƒ ì†Œì‹, ì‹œì¥ í•˜ë½ ì••ë ¥', type: 'negative', impact: -0.04 },
                { text: 'ê¸°ìˆ ì£¼ ì‹¤ì  í˜¸ì¡°, ê¸°ìˆ  ì„¹í„° ìƒìŠ¹', type: 'positive', impact: 0.08, sector: 'technology' },
                { text: 'ìœ ê°€ ê¸‰ë“±, ì—ë„ˆì§€ ì„¹í„° ê°•ì„¸', type: 'positive', impact: 0.1, sector: 'energy' },
                { text: 'ê¸ˆìœµ ê·œì œ ê°•í™” ìš°ë ¤', type: 'negative', impact: -0.06, sector: 'finance' },
                { text: 'ë°”ì´ì˜¤ ì‹ ì•½ ê°œë°œ ì„±ê³µ!', type: 'positive', impact: 0.15, sector: 'bio' },
                { text: 'ë¬´ì—­ ë¶„ìŸ ì‹¬í™” ìš°ë ¤', type: 'negative', impact: -0.05 },
                { text: 'ì‹œì¥ ì•ˆì •ì„¸ ìœ ì§€', type: 'neutral', impact: 0 }
            ];

            const event = events[Math.floor(Math.random() * events.length)];
            addEvent(event.text, event.type);

            gameState.stocks.forEach(stock => {
                if (!event.sector || stock.sector === event.sector) {
                    stock.price = Math.round(stock.price * (1 + event.impact));
                }
            });
        }

        function calculateMA(prices, period) {
            if (prices.length < period) return prices[prices.length - 1];
            const slice = prices.slice(-period);
            return slice.reduce((a, b) => a + b, 0) / period;
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function addEvent(text, type) {
            gameState.eventHistory.unshift({ day: gameState.currentDay, text, type });
            if (gameState.eventHistory.length > 20) gameState.eventHistory.pop();
            
            const eventHtml = gameState.eventHistory.map(e => 
                `<div class="event-item event-${e.type}">Day ${e.day}: ${e.text}</div>`
            ).join('');
            document.getElementById('eventList').innerHTML = eventHtml;
        }

        // ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        function updateDisplay() {
            const totalAssets = calculateTotalAssets();
            const returnRate = ((totalAssets - 10000000) / 10000000) * 100;
            
            document.getElementById('currentDay').textContent = gameState.currentDay;
            document.getElementById('totalAssets').textContent = formatNumber(totalAssets) + 'ì›';
            document.getElementById('returnRate').textContent = returnRate.toFixed(2) + '%';
            document.getElementById('returnRate').className = 'stat-value ' + (returnRate >= 0 ? 'profit' : 'loss');
            document.getElementById('cash').textContent = formatNumber(gameState.cash) + 'ì›';
            document.getElementById('tradeCount').textContent = `${gameState.tradeCount}/${gameState.maxTrades}`;

            // í¬íŠ¸í´ë¦¬ì˜¤
            const portfolioHtml = Object.entries(gameState.portfolio)
                .filter(([_, amount]) => amount !== 0)
                .map(([symbol, amount]) => {
                    const stock = gameState.stocks.find(s => s.symbol === symbol);
                    const value = amount * stock.price;
                    const isShort = amount < 0;
                    return `
                        <div class="portfolio-item">
                            <div>
                                <strong>${stock.name}</strong>
                                <span style="color: ${isShort ? '#ff4757' : '#00ff88'}">
                                    ${isShort ? 'ê³µë§¤ë„ ' : ''}${Math.abs(amount)}ì£¼
                                </span>
                            </div>
                            <div>${formatNumber(value)}ì›</div>
                        </div>
                    `;
                }).join('');
            document.getElementById('portfolioList').innerHTML = portfolioHtml || '<p>ë³´ìœ  ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';

            updateSelectedStockInfo();

            // ë©€í‹°í”Œë ˆì´ì–´ ìì‚° ì—…ë°ì´íŠ¸
            if (gameState.mode === 'multi' && gameState.roomCode && db) {
                db.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}/assets`).set(totalAssets);
            }
        }

        function calculateTotalAssets() {
            let total = gameState.cash;
            for (let symbol in gameState.portfolio) {
                const stock = gameState.stocks.find(s => s.symbol === symbol);
                total += gameState.portfolio[symbol] * stock.price;
            }
            return total;
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('ko-KR');
        }

        // ê²Œì„ ë£¨í”„
        let gameInterval;
        function startGameLoop() {
            gameInterval = setInterval(() => {
                if (gameState.isPaused) return;

                gameState.currentDay++;
                gameState.tradeCount = 0;

                updateMarket();
                
                if (gameState.mode === 'ai') {
                    aiTrade();
                }

                const totalAssets = calculateTotalAssets();
                gameState.assetHistory.push(totalAssets);

                updateDisplay();

                if (gameState.currentDay > 30) {
                    endGame();
                }
            }, 10000); // 10ì´ˆ = 1ì¼
        }

        // ê²Œì„ ì¢…ë£Œ
        function endGame() {
            clearInterval(gameInterval);
            gameState.isPaused = true;

            const finalAssets = calculateTotalAssets();
            const returnRate = ((finalAssets - 10000000) / 10000000) * 100;
            
            // í†µê³„ ê³„ì‚°
            const stats = calculateStatistics();
            
            // ê²°ê³¼ í‘œì‹œ
            const resultHtml = `
                <h3>${returnRate >= 0 ? 'ìˆ˜ìµ ë‹¬ì„±! ğŸ‰' : 'ì†ì‹¤ ë°œìƒ ğŸ˜¢'}</h3>
                <div style="margin: 20px 0;">
                    <p><strong>ìµœì¢… ìì‚°:</strong> ${formatNumber(finalAssets)}ì›</p>
                    <p><strong>ìˆ˜ìµë¥ :</strong> <span class="${returnRate >= 0 ? 'profit' : 'loss'}">${returnRate.toFixed(2)}%</span></p>
                    <p><strong>MDD(ìµœëŒ€ë‚™í­):</strong> ${stats.mdd.toFixed(2)}%</p>
                    <p><strong>ìŠ¹ë¥ :</strong> ${stats.winRate.toFixed(2)}%</p>
                    <p><strong>ìƒ¤í”„ ì§€ìˆ˜:</strong> ${stats.sharpeRatio.toFixed(2)}</p>
                    <p><strong>ê±°ë˜ íšŸìˆ˜:</strong> ${gameState.tradeHistory.length}íšŒ</p>
                </div>
                ${gameState.mode === 'ai' ? `
                    <h4>AI ëŒ€ì „ ê²°ê³¼</h4>
                    <p>AI ìµœì¢… ìì‚°: ${formatNumber(gameState.aiPlayer.assets)}ì›</p>
                    <p>${finalAssets > gameState.aiPlayer.assets ? 'ìŠ¹ë¦¬! ğŸ†' : 'íŒ¨ë°° ğŸ˜”'}</p>
                ` : ''}
            `;
            document.getElementById('resultContent').innerHTML = resultHtml;

            // ê²°ê³¼ ì°¨íŠ¸
            drawResultChart();

            // Firebaseì— ì €ì¥
            saveResults(finalAssets, returnRate, stats);

            document.getElementById('resultModal').style.display = 'flex';
        }

        function calculateStatistics() {
            // MDD ê³„ì‚°
            let maxAsset = gameState.assetHistory[0];
            let maxDrawdown = 0;
            gameState.assetHistory.forEach(asset => {
                if (asset > maxAsset) maxAsset = asset;
                const drawdown = ((maxAsset - asset) / maxAsset) * 100;
                if (drawdown > maxDrawdown) maxDrawdown = drawdown;
            });

            // ìŠ¹ë¥  ê³„ì‚°
            const profitTrades = gameState.tradeHistory.filter(trade => {
                const stock = gameState.stocks.find(s => s.symbol === trade.stock);
                const currentPrice = stock.price;
                if (trade.type === 'buy') return currentPrice > trade.price;
                if (trade.type === 'sell') return currentPrice < trade.price;
                return false;
            }).length;
            const winRate = gameState.tradeHistory.length > 0 
                ? (profitTrades / gameState.tradeHistory.length) * 100 : 0;

            // ìƒ¤í”„ ì§€ìˆ˜ ê³„ì‚°
            const returns = [];
            for (let i = 1; i < gameState.assetHistory.length; i++) {
                returns.push((gameState.assetHistory[i] - gameState.assetHistory[i-1]) / gameState.assetHistory[i-1]);
            }
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length;
            const stdDev = Math.sqrt(variance);
            const sharpeRatio = stdDev > 0 ? (avgReturn - 0.02/30) / stdDev : 0;

            return { mdd: maxDrawdown, winRate, sharpeRatio };
        }

        function drawResultChart() {
            const ctx = document.getElementById('resultChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: gameState.assetHistory.map((_, i) => `Day ${i}`),
                    datasets: [{
                        label: 'ìì‚° ë³€í™”',
                        data: gameState.assetHistory,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0' } }
                    },
                    scales: {
                        y: { ticks: { color: '#e0e0e0' } },
                        x: { ticks: { color: '#e0e0e0' } }
                    }
                }
            });
        }

        function saveResults(finalAssets, returnRate, stats) {
            if (!db) {
                console.log('Firebase ë¯¸ì„¤ì • - ê²°ê³¼ ì €ì¥ ìƒëµ');
                return;
            }

            const resultData = {
                playerName: gameState.playerName,
                playerId: gameState.playerId,
                mode: gameState.mode,
                finalAssets: finalAssets,
                returnRate: returnRate,
                mdd: stats.mdd,
                winRate: stats.winRate,
                sharpeRatio: stats.sharpeRatio,
                trades: gameState.tradeHistory.length,
                timestamp: Date.now()
            };

            // ì „ì²´ ìˆœìœ„ ì €ì¥
            db.ref('rankings/overall/' + gameState.playerId).set({
                name: gameState.playerName,
                return: returnRate,
                timestamp: Date.now()
            });

            // ì£¼ê°„ ìˆœìœ„ ì €ì¥
            db.ref('rankings/weekly/' + gameState.playerId).set({
                name: gameState.playerName,
                return: returnRate,
                timestamp: Date.now()
            });

            // ì¹œêµ¬ ëŒ€ê²° ê²°ê³¼ ì €ì¥
            if (gameState.mode === 'multi' && gameState.roomCode) {
                db.ref('rankings/friends/' + gameState.roomCode + '/' + gameState.playerId).set({
                    name: gameState.playerName,
                    return: returnRate,
                    timestamp: Date.now()
                });
            }

            // ìƒì„¸ ê²°ê³¼ ì €ì¥
            db.ref('results/' + gameState.playerId + '/' + Date.now()).set(resultData);
        }

        // ë­í‚¹ í‘œì‹œ
        function showRankings() {
            document.getElementById('rankingModal').style.display = 'flex';
            showRankingTab('overall');
        }

        function showRankingTab(type) {
            document.querySelectorAll('#rankingModal .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (!db) {
                document.getElementById('rankingContent').innerHTML = '<p>Firebaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const path = type === 'overall' ? 'rankings/overall' : 
                         type === 'weekly' ? 'rankings/weekly' : 
                         'rankings/friends';

            db.ref(path).orderByChild('return').limitToLast(50).once('value').then(snapshot => {
                const rankings = [];
                snapshot.forEach(child => {
                    rankings.push({ id: child.key, ...child.val() });
                });
                rankings.reverse();

                const html = rankings.map((rank, index) => {
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                    const colorClass = rank.return >= 0 ? 'profit' : 'loss';
                    return `
                        <div class="ranking-item">
                            <span><span class="ranking-medal">${medal}</span>${index + 1}. ${rank.name}</span>
                            <span class="${colorClass}">${rank.return.toFixed(2)}%</span>
                        </div>
                    `;
                }).join('');

                document.getElementById('rankingContent').innerHTML = html || '<p>ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function saveGameState() {
            localStorage.setItem('stockGameState', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('stockGameState');
            if (saved) {
                const loaded = JSON.parse(saved);
                if (loaded.currentDay <= 30) {
                    return confirm('ì €ì¥ëœ ê²Œì„ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?') ? loaded : null;
                }
            }
            return null;
        }

        // ì£¼ê¸°ì  ì €ì¥
        setInterval(() => {
            if (gameState.currentDay > 0 && gameState.currentDay <= 30) {
                saveGameState();
            }
        }, 30000);
    </script>
</body>
</html>